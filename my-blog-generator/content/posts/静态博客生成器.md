---
title: "静态博客生成器"
date: "2025-08-20"
tags: ["解析"]
---


---

#  静态博客生成器

这段代码实现了一个简易的 **静态博客生成工具**，使用 TypeScript/Node.js 编写。它会读取 `content/posts` 下的 Markdown 文件，解析后生成 HTML 页面，并输出到 `dist` 目录。

核心功能包括：

* **Markdown 渲染**（支持 MathJax 数学公式）
* **分页的文章列表**
* **文章详情页**
* **标签页**
* **站点地图 (sitemap.xml)**
* **静态资源复制**

下面分模块解析。

---

## 一、目录与配置

```ts
const POSTS_PER_PAGE = 6;
const CONTENT_DIR = path.join(process.cwd(), 'content/posts');
const DIST = path.join(process.cwd(), 'dist');
const TEMPLATE_DIR = path.join(process.cwd(), 'templates');
const STATIC_DIR = path.join(process.cwd(), 'static');
```

* **POSTS\_PER\_PAGE**: 每页显示 6 篇文章。
* **CONTENT\_DIR**: Markdown 文章存放路径。
* **DIST**: 最终构建输出目录。
* **TEMPLATE\_DIR**: 存放 HTML 模板（头部、尾部）。
* **STATIC\_DIR**: 存放静态文件（CSS、JS、图片等）。

---

## 二、工具函数

```ts
function ensureDir(p: string) { ... }
function formatDate(d: string | Date) { ... }
function daysAgo(date: string | Date) { ... }
function readFile(p: string) { ... }
function escapeHtml(s: string) { ... }
```

### 主要功能

* **ensureDir**: 确保目录存在。
* **formatDate**: 格式化日期，输出 `YYYY-MM-DD`。
* **daysAgo**: 计算“几天前”的相对时间，如“今天”“1 天前”“X 天前”。
* **readFile**: 读取文件（若不存在返回空字符串）。
* **escapeHtml**: 防止 HTML 注入，对字符串做转义。

---

## 三、加载文章

```ts
const md = new MarkdownIt({ html: true }).use(mathjax3);
const posts: any[] = [];
```

这里使用了 **Markdown-it** 作为渲染器，并加载 `markdown-it-mathjax3` 插件，支持数学公式。

然后依次读取 `content/posts` 下的 Markdown 文件，解析并生成文章对象：

```ts
const { data, content } = matter(raw);
const html = md.render(content);
```

* **gray-matter**: 用来解析 Markdown 文件头的 **YAML Front Matter**（如 `title`, `date`, `tags`）。
* **content**: Markdown 正文，转为 HTML。
* **stats**: 文件元信息（创建时间、修改时间）。
* **summary**: 优先使用 front-matter 的 `summary`，否则取正文第一行。

最终得到的 `post` 对象包括：

```json
{
  "slug": "文件名",
  "title": "标题",
  "date": "发布日期",
  "updated": "最后修改时间",
  "tags": ["标签1", "标签2"],
  "content": "<html内容>",
  "summary": "文章摘要"
}
```

---

## 四、文章排序与分页

```ts
posts.sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime());
const totalPages = Math.ceil(posts.length / POSTS_PER_PAGE);
```

* 按 **日期降序** 排序（最新的文章在前）。
* 计算总页数。

---

## 五、输出准备

```ts
fs.rmSync(DIST, { recursive: true, force: true });
ensureDir(DIST);
fs.cpSync(STATIC_DIR, path.join(DIST, 'static'), { recursive: true });
```

* 删除旧的 `dist`，重新生成。
* 复制 `static` 目录下的静态资源到输出目录。

并读取模板：

```ts
const header = readFile(path.join(TEMPLATE_DIR, 'header.html'));
const footer = readFile(path.join(TEMPLATE_DIR, 'footer.html'));
```

---

## 六、分页导航

```ts
function renderPagination(cur: number, total: number) {
  ...
}
```

* 如果不是第一页，提供“上一页”链接。
* 显示“第 X / Y 页”。
* 如果不是最后一页，提供“下一页”链接。
* 永远有“首页”和“末页”链接。

---

## 七、生成首页 & 分页

```ts
for (let page = 1; page <= totalPages; page++) {
  const slice = posts.slice(start, start + POSTS_PER_PAGE);
  ...
  fs.writeFileSync(path.join(targetDir, 'index.html'), full, 'utf-8');
}
```

* 遍历分页，每页生成一个 `index.html`。
* 第 1 页直接放在 `/dist/index.html`，其他页放在 `/dist/page/X/index.html`。

页面内容包括：

* **文章列表**
* **分页导航**

---

## 八、生成文章详情页

```ts
for (const post of posts) {
  ...
  fs.writeFileSync(path.join(targetDir, 'index.html'), full, 'utf-8');
}
```

每篇文章生成一个独立页面：

* 地址：`/posts/slug/index.html`
* 内容：标题、发布时间、更新时间、标签、正文

---

## 九、生成标签页

```ts
const tagMap: Record<string, any[]> = {};
```

* 收集所有标签 → 对应文章。
* 为每个标签生成一个列表页：
  `/tags/标签名/index.html`

---

## 十、生成 Sitemap

```ts
function generateSitemap() {
  const baseUrl = 'https://example.com'; // 替换为真实域名
  ...
  fs.writeFileSync(path.join(DIST, 'sitemap.xml'), xml, 'utf-8');
}
```

* 包含首页、分页、文章页、标签页。
* 输出 `sitemap.xml`，便于搜索引擎抓取。

---

## 总结

这份 `build.ts` 脚本实现了一个简易的 **静态博客生成器**，主要功能如下：

1. 解析 Markdown 文章（支持公式）。
2. 自动提取元数据（日期、标签、摘要）。
3. 生成首页、分页、文章详情页、标签页。
4. 自动生成站点地图。
5. 支持静态资源复制和模板拼接。

### 可以改进的方向

* 添加 **RSS/Atom feed** 支持。
* 优化文章摘要（比如截断 HTML 内容，而不是纯文本）。
* 添加 **归档页（按年份/月份）**。
* 添加 **搜索功能（JS 前端实现）**。

---
